### 가입부터 결제 완료까지

#### 0. 당신은 온라인 상점 '토스몰'을 열었습니다.

당신은 티셔츠를 파는 온라인 상점 '토스몰'을 열었습니다.

물건을 구매하려는 손님에게 어떻게 돈을 받을지 고민하던 당신, 여러 결제 서비스를 보며 고민하다가 개발이 쉽고 손님들도 편하게 쓸 수 있는 '토스 결제 서비스'를 써보기로 합니다.

#### 1. 토스 가맹점 계정을 만듭니다.

먼저 [가입 문의](https://toss.im/pay)를 통해 가맹점 가입을 신청합니다. 가입 승인이 완료되면 가맹점 계정이 발급되고, [가맹점 관리자](https://toss.im/tosspay/)에 로그인하여 상점을 등록할 수 있습니다.

당신은 안내에 따라 정보를 입력하고 상점 '토스몰 (가칭)'을 생성합니다. 생성이 완료되면 상점 '토스몰'의 **API Key 가 발급됩니다.** (발급받은 API Key 는 '가맹점 관리자 > 상점 정보'에서 확인할 수 있습니다)

발급된 상점 API Key 는 결제 생성 / 환불 등 모든 거래에서 인증 수단으로 활용합니다.

API Key 가 외부에 유출되면 원치않는 결제 생성이나 환불 처리가 발생하여 금전적인 손실이 발생할 수 있습니다. API key 가 웹사이트에 노출되거나 외부인에게 유출되지 않도록 주의해주세요.

발급되는 API Key 는 두 가지입니다. (테스트용 / 실거래용) 두 Key 는 아래와 같은 차이가 있습니다.

* **테스트용 Key** : 이 Key 를 사용하면 결제의 모든 과정이 실제 결제와 동일하게 진행됩니다. 통장에서 결제 금액이 '출금'되는 것만 빼고요. 돈 빠져나갈 걱정 없이 마음껏 테스트해볼 수 있기 때문에 개발 시 유용하게 사용할 수 있습니다.
* **실거래용 Key** : 이 Key 를 사용해야 진짜 '출금'되는 결제를 할 수 있습니다. 상점에 오신 손님과 결제를 진행할 땐 꼭 이것을 사용해야 합니다.

토스 결제를 한번 테스트 해보고싶지만 당장 가입하긴 귀찮다면, 아래 테스트용 Key 를 사용하세요.

> 테스트용 API Key : sk_test_apikey1234567890a

#### 2. 토스몰에 첫 손님 등장 - 토스 결제 생성을 요청합니다.

'홍길동'씨는 토스몰을 둘러보다가 35,000 원짜리 '토스 티셔츠'를 선택하여 결제를 요청합니다. 이 때 토스몰은 토스 결제 서버에게 '결제 생성'을 요청해야합니다. 결제 생성 API 를 호출하세요!

> 결제 생성 API Endpoint
> **POST https://toss.im/tosspay/api/v1/payments**

'홍길동'씨의 결제는 아래와 같이 요청합니다.

```curl
curl https://toss.im/tosspay/api/v1/payments \
-H "content-Type: application/json" \
-d '{
"orderNo":"1",
"amount":35000,
"productDesc":"토스티셔츠",
"apiKey":"sk_test_apikey1234567890a",
"autoExecute":false,
"retUrl":"http://YOUR-SITE.COM/ORDER-CHECK"
}'
```

위 예제에서 알 수 있듯이 '결제 생성'을 위해서는 6 가지 설정값을 담아 토스에 요청해야합니다.

1. **orderNo (상점 주문번호)** : 추후 상점 주문 정보와 결제 정보를 매칭하기 위해 필요
2. **amount (결제 금액)** : 손님으로부터 받을 금액
3. **productDesc (상품 정보)** : 결제할 상품에 대한 정보 (상품명)
4. **apiKey (상점 API Key)** : 이곳에 '테스트용 Key'를 넣으면 테스트 결제가, '실거래용 Key'를 넣으면 진짜 출금되는 결제가 생성됩니다.
5. **autoExecute (자동 승인 설정)** : false 로 설정할 것을 권장합니다. 이 값을 true 로 설정할 경우, 가맹점의 최종 승인 과정 없이 결제가 자동 완료됩니다.
6. **retUrl (인증 완료 후 연결할 URL)** : 구매자가 결제 인증을 완료하면 이 곳에 입력한 URL 로 연결해드립니다. 일반적으로 '가맹점의 최종 승인을 대기' 하는 페이지를 이곳에 넣습니다.

앞서 말씀 드렸듯, API Key 는 절대 유출되어선 안됩니다. 결제 요청 내용이 웹페이지에 그대로 드러나지 않게 다시 한번 주의해주세요!

요청하신 결제 생성이 무사히 완료되면, 토스는 아래와 같이 응답합니다.

```json
{
  "code": 0,
  "checkoutPage":
    "https://toss.im/tosspay/order/orderWait?payToken=test_token1234567890a&retUrl=http://YOUR-SITE.COM/ORDER-CHECK",
  "payToken": "test_token1234567890a"
}
```

`code '0'`은 결제 생성에 '성공'했음을 나타냅니다.

`checkoutPage`는 생성된 결제를 진행할 웹페이지 URL 입니다. (구매자를 이 URL 로 보내주세요)

`payToken` 값은 생성된 결제건의 고유번호입니다. 결제를 진행할 때, 결제를 취소하거나 환불할 때, 결제의 현재 상태를 파악할 때 이 고유번호를 통해 해당 결제 건에 접근하게 되니 잘 보관해주세요!

#### 3. 구매자 승인 받기

Toss 결제 진행은 간단합니다. 결제 생성 시 응답으로 받은 `checkoutPage` URL 로 구매자를 보내주시기만 하면 됩니다.

위 예제의 checkoutPage 는 아래와 같습니다. (매 결제마다 다른 URL 이 발급됩니다)

```
https://toss.im/tosspay/order/orderWait?payToken=test_token1234567890a
&retUrl=http://YOUR-SITE.COM/ORDER-CHECK
```

그 후, 결제 승인까지의 모든 과정은 토스가 알아서 해드립니다. (결제에 사용할 계좌번호를 받고, 계좌의 유효성을 검증하고, 계좌의 주인인지 철저히 알아보는 등...)

올바른 URL 로 연결하셨다면 홍길동님은 아래와 같은 화면을 통해 결제를 진행하게 됩니다.

![결제 진행 흐름](http://tossdev.github.io/images/flow_pay.png)

> 1. **홍길동님이 토스 결제를 처음 만났다면** : 사용할 계좌를 등록하고, 결제 시 사용할 암호를 등록한 후 결제 완료 (액티브 X 나 앱설치가 필요 없습니다)
>
> 2. **홍길동님이 토스 결제를 써봤다면** : 전화번호와 암호를 입력하면 결제 완료 (보안상 필요 시 ARS 인증을 거칩니다)
>
> 직접 경험해보고 싶으시다면... [>> 결제 데모 페이지 바로가기](https://toss.im/payfront/demo)

#### 4. 구매자 승인 완료

아래 그림과 같이, 홍길동님이 결제 암호를 잘 입력하면 구매자 승인이 완료됩니다. 그러면 토스는 결제 생성 시 넘겨주신 'retUrl'로 홍길동님을 보내드립니다.![결제 완료 처리](http://tossdev.github.io/images/flow_pay_complete.png)

retUrl 로 홍길동님을 보내면서, 주문 번호 (orderNo)와 승인 결과 (status) query string 파라미터로 함께 보내드립니다. 예시는 다음과 같습니다.

```
http://YOUR-SITE.COM/ORDER-CHECK?orderNo=1&status=PAY_APPROVED
```

여기서 status 값을 확인해주세요.

* **승인 완료한 경우** : ?status=PAY_APPROVED
* **결제를 취소한 경우** : ?status=PAY_CANCEL

결제를 취소한 경우에는 결제 취소 안내 화면을 보여주시고, 승인 완료한 경우엔 다음 단계 - 가맹점 최종 승인을 진행합니다.

#### 5. 가맹점 최종 승인

홍길동님은 결제를 승인했지만, 아직 결제가 완료된 상태는 아닙니다. '토스몰'의 최종 승인 단계가 남아있습니다.

최종 승인 전, 토스몰은 토스티셔츠의 재고가 충분한지 다시 한번 확인하고 문제가 없음을 확인한 후 '승인 요청'을 보내고자 합니다.

결제 승인 API Endpoint
**POST https://toss.im/tosspay/api/v1/execute**

결제 승인 요청은 아래와 같이 '상점 API key'와 'payToken'값을 담아 보냅니다.

```curl
curl https://toss.im/tosspay/api/v1/execute \
-H "content-Type: application/json" \
-d '{
"apiKey":"sk_test_apikey1234567890a",
"payToken":"test_token1234567890a"
}'
```

토스몰의 승인 요청을 받으면 토스 결제 서버는 먼저 구매자의 승인이 정말 완료되었는지 다시 한번 확인합니다. (구매자가 악의적으로 URL 변조를 통해 승인 완료인 척 했다면 여기서 결제가 중지됩니다)

승인이 완료된 것을 확인한 후, 구매자의 결제 계좌에서 결제 금액을 출금합니다. 출금이 완료되면 승인 요청에 대한 응답을 토스몰로 보냅니다.

```
{"code":0}
```

'성공'을 의미하는 '0' 코드를 받으셨다면, 결제를 완료 처리하고 구매자를 결제 완료 페이지로 안내해주세요.

실패를 의미하는 '-1' 코드를 받으셨거나, 응답을 받지 못했다면 결제를 완료 처리하지 마십시오.

> 다시 한번 말씀드리지만, 결제 승인 API 요청의 응답이 '성공' (코드 0)인지 반드시 확인하셔야 합니다.
> 계좌 잔액 부족이나 구매자의 URL 변조가 확인되어 '실패' (코드 -1)응답을 받을 수 있습니다. 응답을 확인하지 않고 결제 완료 처리하는 경우, 결제는 실패했으나 물품은 발송되어버릴 수도 있으니 주의하세요!

> 결제 상태가 명확하지 않거나 다시 한번 확인하고 싶다면 ['결제 상태 확인 API'](http://tossdev.github.io/gettingstarted.html#checkstatus)를 통해 결제 상태를 조회하세요.
